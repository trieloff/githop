#!/bin/zsh

basetag="trieloff/"
tag="githop"

if [[ "$1" == .* ]]; then
	tag="${tag}${1#.}"
fi
if [[ "$1" == :* ]]; then
	tag="${basetag}${tag}${1}"
	shift
fi

echo $tag

name=$(echo $1 | sed -e "s/.*\\///" | sed -e "s/\\.git$//")

dockers=$(docker ps | wc -l | sed -e "s/ //g")

CONTAINER=$(docker run -p ${dockers}445:445 -it -d ${tag})

if [ $(uname) = "Darwin" ]; then

	echo "Setting up AFP daemon"
fi

echo "Copying essential files"
docker cp ~/.ssh/id_rsa $CONTAINER:/root/.ssh/id_rsa

echo "Checking out repos in container"
docker exec $CONTAINER /usr/bin/githop $@

if [ $(uname) = "Darwin" ]; then
	mkdir -p $name
	echo "Mounting Evide^H Workspace"
	
fi

echo "Logging into container"
docker attach $CONTAINER

echo "Killing container"
docker kill $CONTAINER

if [ $(uname) = "Darwin" ]; then

	echo "Unmounting Workspace"
	diskutil unmount force $name &
	rm -r $name

fi

echo "Done."